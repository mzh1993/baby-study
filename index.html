
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <base href="./">
    <link rel="manifest" href="manifest.json" onerror="this.onerror=null; this.href='';">
    <title>å®è´è¶£å­¦å ‚ ğŸˆ</title>
    
    <!-- é”™è¯¯å¤„ç†ï¼šå¦‚æœæ— æ³•åŠ è½½ manifest.jsonï¼Œé™é»˜å¤±è´¥ -->
    <script>
        // æ£€æŸ¥æ˜¯å¦åœ¨ file:// åè®®ä¸‹è¿è¡Œï¼Œå¦‚æœæ˜¯åˆ™æç¤ºç”¨æˆ·
        if (window.location.protocol === 'file:') {
            console.warn('æ£€æµ‹åˆ°ä½¿ç”¨ file:// åè®®æ‰“å¼€ï¼Œå»ºè®®ä½¿ç”¨æœ¬åœ° HTTP æœåŠ¡å™¨è¿è¡Œä»¥è·å¾—æœ€ä½³ä½“éªŒ');
        }
    </script>
    
    <!-- Tailwind CSS - ä½¿ç”¨å®˜æ–¹ CDN (è­¦å‘Šä¸å½±å“åŠŸèƒ½) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    
    <!-- React å’Œ ReactDOM - ä½¿ç”¨ jsDelivr CDN (æ›´ç¨³å®š) -->
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone - ä½¿ç”¨ jsDelivr CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7/babel.min.js"></script>

    <style>
        body { 
            font-family: 'ZCOOL KuaiLe', cursive; 
            -webkit-tap-highlight-color: transparent; 
            overflow: hidden; 
            background-color: #FFFBEB;
            touch-action: manipulation;
            user-select: none;
        }
        .bouncy { animation: bounce 0.8s infinite alternate ease-in-out; }
        @keyframes bounce { from { transform: translateY(4px); } to { transform: translateY(-3px); } }
        
        .pop-up { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.6); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .jelly-btn:active { transform: scale(0.92); transition: 0.1s; }
        
        .confetti-piece { position: absolute; width: 12px; height: 12px; top: -20px; opacity: 0; animation: fall 3s ease-out forwards; z-index: 100; }
        @keyframes fall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        ::-webkit-scrollbar { display: none; }
        .safe-area-bottom { padding-bottom: calc(env(safe-area-inset-bottom) + 5rem); }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 4px solid white;
            box-shadow: 0 15px 35px rgba(0,0,0,0.05);
        }

        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .animate-ping {
            animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite;
        }
        @keyframes ping {
            75%, 100% { transform: scale(2); opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- æ•°æ®é…ç½® (å…¨é‡æ•´åˆ) ---
        const WORDS = ["å°é¸¡", "è§é¢", "å°è±¡", "å°ç¾Š", "å°ç‹—", "æ‰‹", "æ‹‰æ‹‰æ‰‹", "æ‹›æ‹›æ‰‹", "çš®çƒ", "é£", "å¤§æ ‘", "å°", "å¤§", "ç«æŠŠ", "å°¾å·´", "æ°´", "é’è›™", "å°æ²³", "é¸­å­", "æ²³é©¬", "ä¹Œé¾Ÿ", "é—¨", "æ°´é¾™å¤´", "å¹¼å„¿å›­", "æ³¡æ³¡", "å–·", "é¦™çš‚", "å¹²å‡€", "æ¯›å·¾", "æ´—", "è½¦ç«™", "æ±½è½¦", "å°çŒª", "å…”å­", "éƒŠæ¸¸", "æœˆç‰™", "å“", "é—¨é“ƒ", "å…¬å›­", "ä¸‹æ£‹", "å¤ªé˜³", "ç”»ç”»", "å¦ˆå¦ˆ", "çˆ¸çˆ¸", "å°çŒ«", "æœ‹å‹", "åœŸ", "ä»“é¼ ", "æ´", "èŠ±", "ä½", "é«˜", "å¥¶å¥¶", "é•¿å¤§", "å“¥å“¥", "çˆ·çˆ·", "å¦¹å¦¹", "çˆ±å¿ƒ", "è¡£æœ", "å¤´å‘"];
        
        const EMOJIS = {"å°é¸¡":"ğŸ¥","è§é¢":"ğŸ™‹","å°è±¡":"ğŸ˜","å°ç¾Š":"ğŸ‘","å°ç‹—":"ğŸ¶","æ‰‹":"âœ‹","æ‹‰æ‹‰æ‰‹":"ğŸ¤","æ‹›æ‹›æ‰‹":"ğŸ‘‹","çš®çƒ":"ğŸ€","é£":"ğŸ’¨","å¤§æ ‘":"ğŸŒ³","å°":"ğŸœ","å¤§":"ğŸ˜","ç«æŠŠ":"ğŸ”¥","å°¾å·´":"ğŸ’","æ°´":"ğŸ’§","é’è›™":"ğŸ¸","å°æ²³":"ğŸŒŠ","é¸­å­":"ğŸ¦†","æ²³é©¬":"ğŸ¦›","ä¹Œé¾Ÿ":"ğŸ¢","é—¨":"ğŸšª","æ°´é¾™å¤´":"ğŸš°","å¹¼å„¿å›­":"ğŸ«","æ³¡æ³¡":"ğŸ«§","å–·":"ğŸš¿","é¦™çš‚":"ğŸ§¼","å¹²å‡€":"âœ¨","æ¯›å·¾":"ğŸ§£","æ´—":"ğŸ›","è½¦ç«™":"ğŸš‰","æ±½è½¦":"ğŸš—","å°çŒª":"ğŸ·","å…”å­":"ğŸ°","éƒŠæ¸¸":"ğŸ•ï¸","æœˆç‰™":"ğŸŒ™","å“":"ğŸ””","é—¨é“ƒ":"ğŸ›ï¸","å…¬å›­":"ğŸï¸","ä¸‹æ£‹":"â™Ÿï¸","å¤ªé˜³":"â˜€ï¸","ç”»ç”»":"ğŸ¨","å¦ˆå¦ˆ":"ğŸ‘©","çˆ¸çˆ¸":"ğŸ‘¨","å°çŒ«":"ğŸ±","æœ‹å‹":"ğŸ‘«","åœŸ":"ğŸŒ±","ä»“é¼ ":"ğŸ¹","æ´":"ğŸ•³ï¸","èŠ±":"ğŸŒ¸","ä½":"ğŸ‘‡","é«˜":"ğŸ‘†","å¥¶å¥¶":"ğŸ‘µ","é•¿å¤§":"ğŸ‚","å“¥å“¥":"ğŸ‘¦","çˆ·çˆ·":"ğŸ‘´","å¦¹å¦¹":"ğŸ‘§","çˆ±å¿ƒ":"â¤ï¸","è¡£æœ":"ğŸ‘•","å¤´å‘":"ğŸ’‡"};

        // è°ƒè¯•é…ç½®ï¼šä¿®æ”¹è¿™ä¸ªæ•°å­—æ¥è°ƒæ•´æŒ‘æˆ˜é¢˜ç›®æ•°é‡
        // è°ƒè¯•æ—¶è®¾ä¸º3ï¼Œå‘å¸ƒæ—¶å¯ä»¥æ”¹ä¸º10æˆ–å…¶ä»–æ•°é‡
        const CHALLENGE_QUESTION_COUNT = 10;

        const SONGS = [
            { id: 's1', title: 'å¨ƒå¨ƒçš„æ‰‹', content: ['ç¦»å¾—è¿œï¼Œæ‹›æ‹›æ‰‹ï¼Œ', 'èµ°è¿‘å•¦ï¼Œæ¡æ¡æ‰‹ã€‚', 'ä¸€èµ·æ¥ï¼Œç‰µç‰µæ‰‹ï¼Œ', 'åšæ¸¸æˆï¼Œé’©é’©æ‰‹ã€‚', 'è·³ä¸ªèˆï¼Œæ‹æ‹æ‰‹ã€‚', 'å†è§å•¦ï¼ŒæŒ¥æŒ¥æ‰‹ã€‚', 'æˆ‘ä»¬éƒ½æ˜¯å¥½æœ‹å‹ï¼Œ', 'äº²äº²çƒ­çƒ­æ‹‰æ‹‰æ‰‹ã€‚'] },
            { id: 's2', title: 'å°å°¾å·´', content: ['å¤§å…¬é¸¡ï¼ŒèŠ±å°¾å·´ï¼Œ', 'èµ°æ¥èµ°å»åƒæœµèŠ±. ', 'å°ç‹ç‹¸ï¼Œçº¢å°¾å·´ï¼Œ', 'è·‘æ¥èµ°å»åƒç«æŠŠã€‚', 'å°è‚¥çŒªï¼Œç»†å°¾å·´ï¼Œ', 'â€œå“¼å“¼â€ä¸€å£°æ‘‡ä¸¤ä¸‹ã€‚', 'å°å®å®ï¼Œè¿½å¦ˆå¦ˆï¼Œ', 'è¦å½“å¦ˆå¦ˆå°å°¾å·´ã€‚'] },
            { id: 's3', title: 'æ•²é—¨', content: ['æˆ‘ä¸€ä¸ªäººåœ¨å®¶çš„æ—¶å€™ï¼Œ', 'æ€»æƒ³çˆ¸çˆ¸å¦ˆå¦ˆæ¥æ•²é—¨ã€‚', 'æˆ‘å’Œçˆ¸çˆ¸åœ¨å®¶çš„æ—¶å€™ï¼Œ', 'æ€»æƒ³å¦ˆå¦ˆæ¥æ•²é—¨ã€‚', 'æˆ‘å’Œå¦ˆå¦ˆåœ¨å®¶çš„æ—¶å€™ï¼Œ', 'æ€»æƒ³çˆ¸çˆ¸æ¥æ•²é—¨ã€‚', 'æˆ‘ä»¬éƒ½åœ¨å®¶çš„æ—¶å€™ï¼Œ', 'æœ‹å‹æ€»ä¼šæ¥æ•²é—¨ã€‚'] },
            { id: 's4', title: 'é£çš„å®¶', content: ['å¤§é£æ²¡æœ‰å®¶ï¼Œ', 'å®ƒåœ¨æ‰¾å¦ˆå¦ˆã€‚', 'æˆ‘æŠŠé—¨å¼€å¼€ï¼Œ', 'ä½ ä¹Ÿæœ‰å®¶äº†ï¼Œ', 'è¿›æ¥å‘€!è¿›æ¥å‘€!', 'ä½ çš„å®¶ï¼Œåœ¨æˆ‘å®¶'] },
            { id: 's5', title: 'å”±æ­Œ', content: ['å°é¸¡å”±æ­Œï¼Œå½å½å½ã€‚', 'å°ç‹—å”±æ­Œï¼Œæ±ªæ±ªæ±ªã€‚', 'å°çŒ«å”±æ­Œï¼Œå–µå–µå–µã€‚', 'è€è™å”±æ­Œï¼Œå—·å—·å—·ã€‚', 'ä¸€ä¼šå„¿è½»ï¼Œä¸€ä¼šå„¿å“ã€‚', 'ä¸€ä¼šå„¿é«˜ï¼Œä¸€ä¼šå„¿ä½ã€‚', 'å¤§å®¶åœ¨ä¸€èµ·ï¼Œæ²¡å…³ç³»ã€‚'] },
            { id: 's6', title: 'æ·‹æµ´', content: ['å¤§ç™½è±¡ï¼Œç¬‘çœ¯çœ¯ï¼Œ', 'å®ƒè¯·å¤§å®¶æ´—æ·‹æµ´ã€‚', 'å°å…”å­ï¼Œå°èŠ±é¸¡ï¼Œ', 'å°é»„ç‹—ï¼Œå°çŒ«å’ªï¼Œ', 'æ´—å‘€æ´—ï¼Œæ´—å‘€æ´—ï¼Œ', 'é•¿é¼»å­å–·æ°´åƒä¸‹é›¨ã€‚'] },
            { id: 's7', title: 'æ‰“ç”µè¯', content: ['æœˆç‰™æœˆç‰™ä¸‹æ¥å§ï¼Œ', 'æˆ‘æƒ³è¯·ä½ æ‰“ç”µè¯ã€‚', 'å‘Šè¯‰å¤©å…¬å…¬:', 'æˆ‘ä»¬æ˜å¤©å»éƒŠæ¸¸ï¼Œ', 'è¯·åˆ«ä¸‹é›¨å‘€!'] },
            { id: 's8', title: 'å¦ˆå¦ˆ', content: ['ä½ ç»™æˆ‘æ´—è„¸ï¼Œ', 'ä½ ç»™æˆ‘æ¢³å¤´å‘ï¼Œ', 'ä½ ç»™æˆ‘æ¢è¡£æœï¼Œ', 'ä½ æ˜¯æˆ‘çš„å¦ˆå¦ˆã€‚', 'æˆ‘ç»™æ´‹å¨ƒå¨ƒæ´—è„¸ï¼Œ', 'æˆ‘ç»™æ´‹å¨ƒå¨ƒæ¢³å¤´å‘ï¼Œ', 'æˆ‘æ˜¯æ´‹å¨ƒå¨ƒçš„å¦ˆå¦ˆã€‚'] }
        ];

        const POEMS = [
            { id: 'p1', title: 'å¯¹éŸµæ­Œ', author: 'é€‰è‡ªå£°å¾‹å¯è’™', content: ['äº‘å¯¹é›¨ï¼Œ', 'é›ªå¯¹é£ã€‚', 'èŠ±å¯¹æ ‘ï¼Œ', 'é¸Ÿå¯¹è™«ã€‚', 'å±±é’å¯¹æ°´ç§€ï¼Œ', 'æŸ³ç»¿å¯¹æ¡ƒçº¢ã€‚'] },
            { id: 'p2', title: 'å’é›ªè¯—', author: 'æ¸….éƒ‘ç‡®', content: ['ä¸€ç‰‡ä¸¤ç‰‡ä¸‰å››ç‰‡ï¼Œ', 'äº”å…­ä¸ƒå…«ä¹åç‰‡ã€‚', 'åƒç‰‡ä¸‡ç‰‡æ— æ•°ç‰‡ï¼Œ', 'é£å…¥æ¢…èŠ±æ€»ä¸è§ã€‚'] },
            { id: 'p3', title: 'å’é¹…', author: 'éª†å®¾ç‹', content: ['é¹…é¹…é¹…ï¼Œ', 'æ›²é¡¹å‘å¤©æ­Œã€‚', 'ç™½æ¯›æµ®ç»¿æ°´ï¼Œ', 'çº¢æŒæ‹¨æ¸…æ³¢ã€‚'] },
            { id: 'p4', title: 'æ±Ÿå—', author: 'æ±‰ä¹åºœ', content: ['æ±Ÿå—å¯é‡‡è²ï¼Œ', 'è²å¶ä½•ç”°ç”°ã€‚', 'é±¼æˆè²å¶é—´ã€‚', 'é±¼æˆè²å¶ä¸œï¼Œ', 'é±¼æˆè²å¶è¥¿ï¼Œ', 'é±¼æˆè²å¶å—ï¼Œ', 'é±¼æˆè²å¶åŒ—ã€‚'] },
            { id: 'p5', title: 'é™å¤œæ€', author: 'æç™½', content: ['åºŠå‰æ˜æœˆå…‰ï¼Œ', 'ç–‘æ˜¯åœ°ä¸Šéœœã€‚', 'ä¸¾å¤´æœ›æ˜æœˆï¼Œ', 'ä½å¤´æ€æ•…ä¹¡ã€‚'] },
            { id: 'p6', title: 'æ˜¥æ™“', author: 'å­Ÿæµ©ç„¶', content: ['æ˜¥çœ ä¸è§‰æ™“ï¼Œ', 'å¤„å¤„é—»å•¼é¸Ÿã€‚', 'å¤œæ¥é£é›¨å£°ï¼Œ', 'èŠ±è½çŸ¥å¤šå°‘ã€‚'] },
            { id: 'p7', title: 'ç™»é¹³é›€æ¥¼', author: 'ç‹ä¹‹æ¶£', content: ['ç™½æ—¥ä¾å±±å°½ï¼Œ', 'é»„æ²³å…¥æµ·æµã€‚', 'æ¬²ç©·åƒé‡Œç›®ï¼Œ', 'æ›´ä¸Šä¸€å±‚æ¥¼ã€‚'] },
            { id: 'p8', title: 'å°å„¿å‚é’“', author: 'èƒ¡ä»¤èƒ½', content: ['è“¬å¤´ç¨šå­å­¦å‚çº¶ï¼Œ', 'ä¾§åè“è‹”è‰æ˜ èº«ã€‚', 'è·¯äººå€Ÿé—®é¥æ‹›æ‰‹ï¼Œ', 'æ€•å¾—é±¼æƒŠä¸åº”äººã€‚'] },
            { id: 'p9', title: 'æ±Ÿé›ª', author: 'æŸ³å®—å…ƒ', content: ['åƒå±±é¸Ÿé£ç»ï¼Œ', 'ä¸‡å¾„äººè¸ªç­ã€‚', 'å­¤èˆŸè“‘ç¬ ç¿ï¼Œ', 'ç‹¬é’“å¯’æ±Ÿé›ªã€‚'] },
            { id: 'p10', title: 'æ‚¯å†œ', author: 'æç»…', content: ['é”„ç¦¾æ—¥å½“åˆï¼Œ', 'æ±—æ»´ç¦¾ä¸‹åœŸã€‚', 'è°çŸ¥ç›˜ä¸­é¤ï¼Œ', 'ç²’ç²’çš†è¾›è‹¦ã€‚'] },
            { id: 'p11', title: 'å¯»éšè€…ä¸é‡', author: 'è´¾å²›', content: ['æ¾ä¸‹é—®ç«¥å­ï¼Œ', 'è¨€å¸ˆé‡‡è¯å»ã€‚', 'åªåœ¨æ­¤å±±ä¸­ï¼Œ', 'äº‘æ·±ä¸çŸ¥å¤„ã€‚'] }
        ];

        const CARD_COLORS = ['border-red-400', 'border-blue-400', 'border-green-400', 'border-yellow-400', 'border-purple-400', 'border-pink-400', 'border-orange-400'];

        // --- å·¥å…·å‡½æ•° ---
        const speak = (text, rate = 0.9) => {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-CN'; u.rate = rate; u.pitch = 1.2;
            window.speechSynthesis.speak(u);
        };

        // --- é€šç”¨ç»„ä»¶ ---
        const Confetti = () => (
            <div className="fixed inset-0 pointer-events-none z-[100] overflow-hidden">
                {[...Array(35)].map((_, i) => (
                    <div key={i} className="confetti-piece" style={{ 
                        left: `${Math.random() * 100}%`, 
                        backgroundColor: ['#ffeb3b', '#e91e63', '#00bcd4', '#4caf50', '#ff5722'][i%5],
                        animationDelay: `${Math.random() * 1.5}s`,
                        width: `${Math.random() * 10 + 8}px`,
                        height: `${Math.random() * 10 + 8}px`,
                        borderRadius: i%2 === 0 ? '50%' : '2px'
                    }} />
                ))}
            </div>
        );

        const Header = ({ title, onBack }) => (
            <div className="fixed top-0 inset-x-0 bg-white/90 backdrop-blur-md p-3 flex items-center shadow-sm z-[60] h-14 pt-[env(safe-area-inset-top)]">
                {onBack && (
                    <button onClick={onBack} className="w-8 h-8 flex items-center justify-center bg-blue-100 rounded-full text-blue-600 active:scale-90 transition-transform">
                        <span className="text-lg">â¬…ï¸</span>
                    </button>
                )}
                <h1 className="flex-1 text-center text-xl font-black text-pink-500 truncate px-3">{title}</h1>
            </div>
        );

        const Navbar = ({ active, setMode }) => (
            <div className="fixed bottom-0 inset-x-0 bg-white/95 border-t border-pink-50 flex justify-around p-2 pb-[calc(env(safe-area-inset-bottom)+0.75rem)] z-[60]">
                {[
                    {id:'HOME', i:'ğŸ ', l:'é¦–é¡µ'},
                    {id:'CARDS', i:'ğŸƒ', l:'è¯†å­—'},
                    {id:'SONGS', i:'ğŸµ', l:'å„¿æ­Œ'},
                    {id:'POEMS', i:'ğŸ“–', l:'è¯—è¯'},
                    {id:'STATS', i:'ğŸ“Š', l:'å®¶é•¿'}
                ].map(n => (
                    <button key={n.id} onClick={() => setMode(n.id)} className={`flex flex-col items-center gap-1 transition-all ${active.startsWith(n.id) ? 'text-pink-500 scale-110' : 'text-gray-400 opacity-60'}`}>
                        <span className="text-2xl">{n.i}</span>
                        <span className="text-[10px] font-bold">{n.l}</span>
                    </button>
                ))}
            </div>
        );

        // --- æ ¸å¿ƒå±å¹• ---
        const HomeScreen = ({ setMode, progress }) => {
            const dailyPercent = Math.min(100, (progress.daily / 10) * 100);
            return (
                <div className="h-screen overflow-y-auto pt-14 pb-28 px-4 space-y-4">
                    <Header title="å®è´è¶£å­¦å ‚" />
                    <div className="bg-white p-4 rounded-[2rem] shadow-xl border-4 border-pink-50">
                        <div className="flex justify-between items-end mb-3">
                            <div>
                                <h2 className="text-lg font-black text-gray-700">ä»Šæ—¥å°æˆå°± âœ¨</h2>
                                <p className="text-xs text-gray-400 font-bold">æ¯å¤©ååˆ†é’Ÿï¼Œå®å®æ›´èªæ˜</p>
                            </div>
                            <span className="text-xl font-black text-pink-500">{progress.daily}/10</span>
                        </div>
                        <div className="w-full bg-gray-100 h-6 rounded-full overflow-hidden shadow-inner p-0.5">
                            <div className="h-full bg-gradient-to-r from-pink-400 via-red-400 to-yellow-400 rounded-full transition-all duration-1000" style={{ width: `${dailyPercent}%` }} />
                        </div>
                    </div>

                    <button onClick={() => setMode('EXAM_SELECT')} className="w-full bg-gradient-to-br from-orange-400 to-yellow-500 p-6 rounded-[2.5rem] shadow-2xl border-b-[10px] border-orange-700 flex items-center justify-between text-white active:translate-y-2 active:border-b-4 transition-all bouncy">
                        <div className="text-left">
                            <h2 className="text-3xl font-black mb-1">å¼€å§‹æŒ‘æˆ˜ ğŸ†</h2>
                            <p className="opacity-90 font-bold tracking-widest text-xs uppercase">èµ¢å–å‹‹ç« å§ï¼</p>
                        </div>
                        <span className="text-6xl">ğŸ¥‡</span>
                    </button>

                    <div className="grid grid-cols-2 gap-3">
                        <button onClick={() => setMode('CARDS')} className="aspect-square bg-blue-400 rounded-[2rem] flex flex-col items-center justify-center text-white shadow-xl border-b-[8px] border-blue-600 active:translate-y-2 active:border-b-4">
                            <span className="text-6xl mb-1">ğŸˆ</span>
                            <span className="text-xl font-black">å¿«ä¹è¯†å­—</span>
                        </button>
                        <button onClick={() => setMode('SONGS')} className="aspect-square bg-pink-400 rounded-[2rem] flex flex-col items-center justify-center text-white shadow-xl border-b-[8px] border-pink-600 active:translate-y-2 active:border-b-4">
                            <span className="text-6xl mb-1">ğŸµ</span>
                            <span className="text-xl font-black">å„¿æ­Œå¤§ç‹</span>
                        </button>
                    </div>
                </div>
            );
        };

        const CardScreen = ({ onBack, onMaster, progress }) => {
            // åˆ›å»ºéšæœºæ’åºçš„ç´¢å¼•æ•°ç»„
            const randomIndices = useMemo(() => {
                const indices = [...Array(WORDS.length).keys()]; // [0, 1, 2, ..., WORDS.length-1]
                for (let i = indices.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [indices[i], indices[j]] = [indices[j], indices[i]];
                }
                return indices;
            }, []); // ç©ºä¾èµ–æ•°ç»„ï¼Œåªåœ¨ç»„ä»¶é¦–æ¬¡æ¸²æŸ“æ—¶ç”Ÿæˆéšæœºé¡ºåº

            const [idx, setIdx] = useState(0);
            const wordIndex = randomIndices[idx];
            const word = WORDS[wordIndex];
            const isMastered = progress.mastered.includes(wordIndex);
            useEffect(() => { speak(word); }, [word]);

            return (
                <div className="h-screen overflow-y-auto bg-white pt-14 px-4 flex flex-col items-center">
                    <Header title="å¿«æ¥è®¤è®¤å®ƒ" onBack={onBack} />
                    <div className="w-full max-w-sm flex-1 max-h-[60vh]">
                        <div onClick={() => speak(word)} className={`h-full w-full glass-card rounded-[3rem] flex flex-col items-center justify-center p-6 border-[10px] transition-all duration-500 cursor-pointer active:scale-95 relative ${CARD_COLORS[wordIndex % CARD_COLORS.length]}`}>
                            {/* å°å–‡å­è£…é¥°å›¾æ ‡ */}
                            <div className="absolute top-3 right-3 text-xl opacity-60">ğŸ”Š</div>

                            <div className="text-[10rem] drop-shadow-2xl mb-3 pop-up">{EMOJIS[word] || "âœ¨"}</div>
                            <h2 className="text-7xl font-black text-gray-800 tracking-tighter drop-shadow-sm">{word}</h2>

                            {/* åº•éƒ¨æç¤ºæ–‡å­— */}
                            <div className="mt-4 text-sm font-bold text-gray-500 opacity-70">ç‚¹å‡»æ’­æ”¾å‘éŸ³</div>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4 w-full max-w-sm my-4">
                        <button onClick={() => setIdx(i => (i - 1 + WORDS.length) % WORDS.length)} className="jelly-btn py-4 bg-gradient-to-b from-blue-400 to-blue-500 rounded-[1.5rem] text-white shadow-xl border-b-6 border-blue-700 flex items-center justify-center gap-2">
                            <span className="text-2xl">â¬…ï¸</span>
                            <span className="text-lg font-black">ä¸Šä¸€ä¸ª</span>
                        </button>
                        <button onClick={() => setIdx(i => (i + 1) % WORDS.length)} className="jelly-btn py-4 bg-gradient-to-b from-blue-400 to-blue-500 rounded-[1.5rem] text-white shadow-xl border-b-6 border-blue-700 flex items-center justify-center gap-2">
                            <span className="text-lg font-black">ä¸‹ä¸€ä¸ª</span>
                            <span className="text-2xl">â¡ï¸</span>
                        </button>
                    </div>

                    <div className="grid grid-cols-2 gap-3 w-full max-w-sm mb-28">
                        <button onClick={() => speak("ç»§ç»­å­¦ä¹ ï¼")} className="py-5 bg-gray-100 text-gray-400 rounded-[1.5rem] font-black text-lg border-b-3 border-gray-200 active:translate-y-1">åœ¨å­¦ä¸­ ğŸ§</button>
                        <button onClick={() => { speak("å­¦ä¼šå•¦ï¼"); onMaster(wordIndex); setIdx(i => (i + 1) % WORDS.length); }} className={`py-5 rounded-[1.5rem] text-lg font-black text-white shadow-lg border-b-6 ${isMastered ? 'bg-green-500 border-green-700' : 'bg-green-400 border-green-600 active:translate-y-1'}`}>
                            {isMastered ? 'å­¦ä¼šå•¦ âœ…' : 'å­¦ä¼šå•¦ ğŸ†'}
                        </button>
                    </div>
                </div>
            );
        };

        const SongScreen = ({ onBack, onRead, progress }) => {
            const [sel, setSel] = useState(null);
            if (sel) return (
                <div className="h-screen bg-gradient-to-br from-pink-50 via-purple-50 to-blue-50 pt-14 px-4 overflow-y-auto pb-28">
                    <Header title={sel.title} onBack={() => setSel(null)} />

                    {/* è£…é¥°æ€§é¡¶éƒ¨å…ƒç´  */}
                    <div className="flex justify-center mb-4">
                        <div className="text-5xl animate-bounce">ğŸµ</div>
                    </div>

                    <div className="bg-white p-6 rounded-[3rem] shadow-2xl border-t-[12px] border-pink-400 pop-up relative overflow-hidden">
                        {/* è£…é¥°èƒŒæ™¯ */}
                        <div className="absolute inset-0 opacity-5 pointer-events-none">
                            <div className="absolute top-3 left-3 text-3xl">ğŸ¼</div>
                            <div className="absolute top-3 right-3 text-3xl">ğŸµ</div>
                            <div className="absolute bottom-3 left-3 text-3xl">ğŸ¶</div>
                            <div className="absolute bottom-3 right-3 text-3xl">ğŸµ</div>
                        </div>

                        {/* æ­Œè¯å†…å®¹ */}
                        <div className="relative z-10 space-y-4">
                            {sel.content.map((l, i) => (
                                <p key={i} onClick={() => speak(l)} className="text-2xl text-center font-black text-gray-700 active:text-pink-500 py-2 transition-all cursor-pointer hover:bg-pink-50 rounded-lg px-3 leading-relaxed">
                                    {l}
                                </p>
                            ))}
                        </div>

                        {/* åº•éƒ¨æŒ‰é’®åŒºåŸŸ */}
                        <div className="mt-8 space-y-3 relative z-10">
                            <button onClick={() => speak(sel.content.join(' '), 0.8)} className="w-full py-5 bg-gradient-to-r from-pink-400 to-purple-500 text-white rounded-[2rem] text-2xl font-black shadow-xl border-b-[8px] border-pink-700 active:translate-y-2 flex items-center justify-center gap-3">
                                <span className="text-3xl">ğŸ”Š</span>
                                <span>å¬å®Œæ•´é¦–å„¿æ­Œ</span>
                            </button>
                            <button onClick={() => { onRead(sel.id); setSel(null); speak("çœŸäº†ä¸èµ·ï¼è¯»å®Œå•¦ï¼"); }} className="w-full py-4 bg-gradient-to-r from-green-400 to-blue-500 text-white rounded-[2rem] text-lg font-black shadow-xl border-b-6 border-green-600 active:translate-y-2 flex items-center justify-center gap-3">
                                <span className="text-xl">âœŒï¸</span>
                                <span>æˆ‘è¯»å®Œå•¦ï¼</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
            return (
                <div className="h-screen overflow-y-auto pt-14 px-4 pb-28 space-y-3">
                    <Header title="å„¿æ­Œå¤§ç‹" onBack={onBack} />
                    {SONGS.map((s, i) => (
                        <div key={s.id} onClick={() => setSel(s)} className="bg-white p-4 rounded-[1.5rem] flex items-center justify-between shadow-md border-l-[10px] border-pink-400 active:scale-95 transition-all">
                            <div className="flex items-center gap-4">
                                <span className="text-4xl">{{'s1':'ğŸ‘¶','s2':'ğŸ¦Š','s3':'ğŸšª','s4':'ğŸ’¨','s5':'ğŸ¤','s6':'ğŸš¿','s7':'ğŸ“','s8':'ğŸ‘©'}[s.id] || 'ğŸµ'}</span>
                                <span className="text-xl font-black text-gray-800">{s.title}</span>
                            </div>
                            {progress.readSongs.includes(s.id) ? <span className="text-green-500 text-xl font-black">âœ…</span> : <span className="text-pink-300 font-black text-lg">â”</span>}
                        </div>
                    ))}
                </div>
            );
        };

        const PoemsScreen = ({ onBack, progress }) => {
            const [sel, setSel] = useState(null);
            if (sel) return (
                <div className="h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 pt-14 px-4 overflow-y-auto pb-28">
                    <Header title={sel.title} onBack={() => setSel(null)} />

                    {/* è£…é¥°æ€§é¡¶éƒ¨å…ƒç´  */}
                    <div className="flex justify-center mb-4">
                        <div className="text-5xl animate-bounce">ğŸ“–</div>
                    </div>

                    <div className="bg-white p-6 rounded-[3rem] shadow-2xl border-t-[12px] border-indigo-400 pop-up relative overflow-hidden">
                        {/* è£…é¥°èƒŒæ™¯ */}
                        <div className="absolute inset-0 opacity-5 pointer-events-none">
                            <div className="absolute top-3 left-3 text-3xl">ğŸ“š</div>
                            <div className="absolute top-3 right-3 text-3xl">ğŸ“–</div>
                            <div className="absolute bottom-3 left-3 text-3xl">âœ¨</div>
                            <div className="absolute bottom-3 right-3 text-3xl">ğŸ“</div>
                        </div>

                        {/* ä½œè€…ä¿¡æ¯ */}
                        <div className="text-center mb-6 relative z-10">
                            <div className="inline-block bg-indigo-100 px-6 py-2 rounded-full border-2 border-indigo-200">
                                <span className="text-lg font-black text-indigo-600">ä½œè€…ï¼š{sel.author}</span>
                            </div>
                        </div>

                        {/* è¯—è¯å†…å®¹ */}
                        <div className="relative z-10 space-y-4">
                            {sel.content.map((l, i) => (
                                <p key={i} onClick={() => speak(l)} className="text-2xl text-center font-black text-gray-700 active:text-indigo-500 py-2 transition-all cursor-pointer hover:bg-indigo-50 rounded-lg px-3 leading-relaxed">
                                    {l}
                                </p>
                            ))}
                        </div>

                        {/* åº•éƒ¨æŒ‰é’®åŒºåŸŸ */}
                        <div className="mt-8 space-y-3 relative z-10">
                            <button onClick={() => speak(sel.content.join(' '), 0.8)} className="w-full py-5 bg-gradient-to-r from-indigo-400 to-purple-500 text-white rounded-[2rem] text-2xl font-black shadow-xl border-b-[8px] border-indigo-700 active:translate-y-2 flex items-center justify-center gap-3">
                                <span className="text-3xl">ğŸ”Š</span>
                                <span>å¬å®Œæ•´é¦–è¯—è¯</span>
                            </button>
                            <button onClick={() => speak("çœŸæ£’ï¼èƒŒä¼šå•¦ï¼")} className="w-full py-4 bg-gradient-to-r from-green-400 to-blue-500 text-white rounded-[2rem] text-lg font-black shadow-xl border-b-6 border-green-600 active:translate-y-2 flex items-center justify-center gap-3">
                                <span className="text-2xl">âœŒï¸</span>
                                <span>èƒŒä¼šå•¦ï¼</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
            return (
                <div className="h-screen overflow-y-auto pt-14 px-4 pb-28 space-y-3">
                    <Header title="å¤è¯—è¯æ¬£èµ" onBack={onBack} />
                    {POEMS.map((p, i) => (
                        <div key={p.id} onClick={() => setSel(p)} className="bg-white p-4 rounded-[1.5rem] flex items-center justify-between shadow-md border-l-[10px] border-indigo-400 active:scale-95 transition-all">
                            <div className="flex items-center gap-4">
                                <span className="text-4xl">ğŸ“–</span>
                                <div>
                                    <span className="text-xl font-black text-gray-800 block">{p.title}</span>
                                    <span className="text-sm font-bold text-indigo-600">{p.author}</span>
                                </div>
                            </div>
                            <span className="text-pink-300 font-black text-lg">â”</span>
                        </div>
                    ))}
                </div>
            );
        };

        const StatsScreen = ({ progress }) => {
            const masterPercent = Math.round((progress.mastered.length / WORDS.length) * 100);
            const hardest = Object.entries(progress.wrong || {}).sort((a,b)=>b[1]-a[1]).slice(0,3);
            return (
                <div className="h-screen overflow-y-auto pt-14 px-4 pb-28 space-y-4">
                    <Header title="æˆé•¿è®°å½•" />
                    <div className="bg-white p-6 rounded-[2.5rem] shadow-xl text-center border-b-[10px] border-purple-100">
                        <p className="text-gray-400 font-bold text-xs mb-3">è¯†å­—æ€»è¿›åº¦</p>
                        <div className="w-full bg-gray-100 h-8 rounded-full overflow-hidden shadow-inner p-1 mb-6">
                            <div className="h-full bg-gradient-to-r from-purple-400 to-red-400 rounded-full transition-all duration-1000" style={{ width: `${masterPercent}%` }} />
                        </div>
                        <div className="flex justify-around items-end">
                            <div><p className="text-5xl font-black text-purple-600">{progress.mastered.length}</p><p className="text-[10px] text-gray-400 mt-2">è®¤è¯†çš„å­—</p></div>
                            <div><p className="text-5xl font-black text-pink-500">{progress.readSongs.length}</p><p className="text-[10px] text-gray-400 mt-2">å­¦ä¼šå„¿æ­Œ</p></div>
                        </div>
                    </div>
                    {hardest.length > 0 && (
                        <div className="bg-[#FFF4E0] p-4 rounded-[2.5rem] border-4 border-orange-100">
                            <h3 className="font-black text-orange-800 mb-3 flex items-center gap-2"><span>ğŸ§ </span> é‡ç‚¹å¤ä¹ </h3>
                            <div className="flex flex-wrap gap-2">
                                {hardest.map(([idx, count]) => (
                                    <div key={idx} className="bg-white px-4 py-2 rounded-xl shadow-sm border-2 border-orange-50 flex items-center gap-2">
                                        <span className="text-2xl font-black">{WORDS[idx]}</span>
                                        <span className="text-red-500 text-[10px] font-bold">è®¤é”™ {count} æ¬¡</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ExamScreen = ({ onBack, onMaster, onWrong }) => {
            const [step, setStep] = useState(0);
            const [score, setScore] = useState(0);
            const [finished, setFinished] = useState(false);
            const [feedback, setFeedback] = useState(null);
            const [retryMode, setRetryMode] = useState(false);
            const justPlayedAudioRef = useRef(false);
            const questions = useMemo(() => {
                // åˆ›å»ºæ‰“ä¹±çš„ç´¢å¼•æ•°ç»„ï¼Œç¡®ä¿ä¸é‡å¤
                const indices = [...Array(WORDS.length).keys()]; // [0, 1, 2, ..., WORDS.length-1]
                for (let i = indices.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [indices[i], indices[j]] = [indices[j], indices[i]];
                }

                // å–å‰ CHALLENGE_QUESTION_COUNT ä¸ªä¸é‡å¤çš„ç´¢å¼•
                const selectedIndices = indices.slice(0, CHALLENGE_QUESTION_COUNT);

                return selectedIndices.map(targetIdx => {
                    const opts = [WORDS[targetIdx], ...WORDS.filter((_, i) => i !== targetIdx).sort(() => 0.5 - Math.random()).slice(0, 2)].sort(() => 0.5 - Math.random());
                    return { targetIdx, opts };
                });
            }, []);

            const current = questions[step];
            useEffect(() => {
                if (!finished && !retryMode && !justPlayedAudioRef.current) {
                    speak(`è¯·æ‰¾å‡ºï¼š${WORDS[current.targetIdx]}`);
                }
                // æ¯æ¬¡ step æ”¹å˜åé‡ç½® justPlayedAudioRef
                justPlayedAudioRef.current = false;
            }, [step, finished, retryMode]);

            const handleAnswer = (ans) => {
                if (feedback) return;
                const correct = ans === WORDS[current.targetIdx];
                if (correct) {
                    speak("ç­”å¯¹å•¦ï¼");
                    setScore(s => s + 1);
                    setFeedback('correct');
                    onMaster(current.targetIdx);
                    setRetryMode(false); // ç­”å¯¹åæ¸…é™¤é‡è¯•æ¨¡å¼
                    setTimeout(() => {
                        setFeedback(null);
                        if (step < CHALLENGE_QUESTION_COUNT - 1) {
                            const nextStep = step + 1;
                            // åœ¨åˆ‡æ¢åˆ°ä¸‹ä¸€é¢˜ä¹‹å‰ï¼Œå…ˆæ’­æ”¾ä¸‹ä¸€é¢˜çš„å‘éŸ³
                            speak(`è¯·æ‰¾å‡ºï¼š${WORDS[questions[nextStep].targetIdx]}`);
                            justPlayedAudioRef.current = true; // æ ‡è®°å·²ç»æ‰‹åŠ¨æ’­æ”¾è¿‡
                            setStep(nextStep);
                        } else {
                            setFinished(true);
                        }
                    }, 1500);
                } else {
                    speak("å†æ‰¾æ‰¾çœ‹ï¼Ÿ");
                    setFeedback('wrong');
                    onWrong(current.targetIdx);
                    setRetryMode(true); // è¿›å…¥é‡è¯•æ¨¡å¼
                    // ç­”é”™åé‡æ–°æ’­æ”¾éŸ³é¢‘ï¼Œè®©å­©å­é‡æ–°å¬
                    setTimeout(() => {
                        setFeedback(null);
                        speak(`è¯·æ‰¾å‡ºï¼š${WORDS[current.targetIdx]}`); // é‡æ–°æ’­æ”¾
                    }, 1500);
                }
            };

            if (finished) return (
                <div className="h-screen pt-20 px-8 flex flex-col items-center justify-center space-y-8 bg-pink-50">
                    <Header title="æŒ‘æˆ˜ç»“æœ" />
                    <div className="bg-white w-full p-12 rounded-[4rem] shadow-2xl text-center pop-up">
                        <div className="text-[8rem] mb-6">ğŸ¥‡</div>
                        <h2 className="text-4xl font-black text-gray-800">æŒ‘æˆ˜å®Œæˆï¼</h2>
                        <div className="text-8xl font-black text-pink-500 my-8">{score}/{CHALLENGE_QUESTION_COUNT}</div>
                        <button onClick={onBack} className="w-full py-6 bg-green-500 text-white rounded-[2.5rem] text-3xl font-black shadow-xl border-b-8 border-green-700">è¿”å›ä¸»é¡µ</button>
                    </div>
                </div>
            );

            return (
                <div className="h-screen bg-white pt-14 px-4 flex flex-col items-center">
                    <Header title={`æŒ‘æˆ˜ä¸­ ${step + 1}/${CHALLENGE_QUESTION_COUNT}`} onBack={onBack} />

                    {/* å‘éŸ³åŒºåŸŸ - æ•´ä¸ªåŒºåŸŸéƒ½å¯ä»¥ç‚¹å‡» */}
                    <div
                        onClick={() => speak(WORDS[current.targetIdx])}
                        className={`w-full max-w-sm aspect-square glass-card rounded-[3rem] flex flex-col items-center justify-center p-6 pt-8 pb-8 border-[12px] transition-all duration-300 cursor-pointer active:scale-95 relative overflow-hidden ${feedback === 'correct' ? 'border-green-400 scale-105' : feedback === 'wrong' ? 'border-red-400' : 'border-blue-100'}`}
                    >
                        {/* è£…é¥°èƒŒæ™¯ - æœ€åº•å±‚ */}
                        <div className="absolute inset-0 opacity-5 pointer-events-none z-0">
                            <div className="absolute top-3 left-3 text-2xl">ğŸ”¤</div>
                            <div className="absolute top-3 right-3 text-2xl">ğŸ“š</div>
                            <div className="absolute bottom-3 left-3 text-2xl">ğŸ“</div>
                            <div className="absolute bottom-3 right-3 text-2xl">âœ¨</div>
                        </div>

                        {/* ä¸»è¦å†…å®¹åŒºåŸŸ - ä¸­é—´å±‚ */}
                        <div className="text-center relative z-10 w-full flex flex-col items-center justify-center">
                            {/* å‘éŸ³æç¤ºæ ‡é¢˜ - é¡¶éƒ¨ */}
                            <div className="text-lg font-black text-pink-600 mb-3 flex items-center justify-center gap-2">
                                <span className="text-xl animate-pulse">ğŸ”Š</span> å¬å¬è¿™ä¸ªå­—æ€ä¹ˆå¿µ <span className="text-xl animate-pulse">ğŸ”Š</span>
                            </div>

                            {/* Emojiæ˜¾ç¤º - ä¸»è¦è§†è§‰ç„¦ç‚¹ï¼Œé¢„ç•™è·³åŠ¨ç©ºé—´ */}
                            <div className="text-[10rem] bouncy mb-3 relative z-20 mt-4 pt-2 pb-2">{EMOJIS[WORDS[current.targetIdx]]}</div>

                            {/* ç­”å¯¹åæ‰æ˜¾ç¤ºæ–‡å­—ç¡®è®¤ */}
                            {feedback === 'correct' && (
                                <div className="text-6xl font-black text-green-600 mb-2 relative z-20 drop-shadow-lg">
                                    {WORDS[current.targetIdx]}
                                </div>
                            )}

                            {/* ç‚¹å‡»æç¤º - åº•éƒ¨ */}
                            {!feedback && (
                                <div className="mt-2 text-sm font-bold text-pink-500 animate-pulse relative z-20">
                                    {retryMode ? 'ğŸ”„ å†å¬å¬ï¼Œé€‰æ‹©æ­£ç¡®çš„ç­”æ¡ˆå§ï¼' : 'ğŸ‘† ç‚¹å‡»ä»»æ„ä½ç½®å‘éŸ³'}
                                </div>
                            )}
                        </div>
                    </div>
                    <div className="grid grid-cols-1 gap-3 w-full max-w-sm mt-6 mb-28">
                        {current.opts.map(opt => (
                            <button key={opt} onClick={() => handleAnswer(opt)} className="py-5 bg-white rounded-[2rem] text-4xl font-black text-gray-700 shadow-xl border-b-[8px] border-gray-100 active:translate-y-2">
                                {opt}
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        const SongRecognitionExamScreen = ({ onBack, onSongMaster }) => {
            const [step, setStep] = useState(0);
            const [score, setScore] = useState(0);
            const [finished, setFinished] = useState(false);
            const [feedback, setFeedback] = useState(null);
            const [retryMode, setRetryMode] = useState(false);
            const justPlayedAudioRef = useRef(false);

            const questions = useMemo(() => {
                // ä¸ºæ¯ä¸ªé¢˜ç›®åˆ›å»º3ä¸ªé€‰é¡¹ï¼šéšæœºé€‰æ‹©3å¥ä¸åŒçš„æ­Œè¯
                return [...Array(CHALLENGE_QUESTION_COUNT)].map(() => {
                    // ä»æ‰€æœ‰å„¿æ­Œä¸­éšæœºé€‰æ‹©3å¥ä¸åŒçš„æ­Œè¯ä½œä¸ºé€‰é¡¹
                    const availableLyrics = [];
                    SONGS.forEach(song => {
                        song.content.forEach(lyric => {
                            availableLyrics.push({ lyric, songTitle: song.title });
                        });
                    });

                    // éšæœºé€‰æ‹©3å¥ä¸åŒçš„æ­Œè¯
                    const selectedLyrics = [];
                    while (selectedLyrics.length < 3 && availableLyrics.length > 0) {
                        const randomIndex = Math.floor(Math.random() * availableLyrics.length);
                        const selected = availableLyrics.splice(randomIndex, 1)[0];
                        selectedLyrics.push(selected);
                    }

                    // éšæœºé€‰æ‹©å…¶ä¸­ä¸€å¥ä½œä¸ºæ­£ç¡®ç­”æ¡ˆæ’­æ”¾
                    const correctIndex = Math.floor(Math.random() * 3);
                    const correctLyric = selectedLyrics[correctIndex];

                    // é€‰é¡¹æ˜¯è¿™3å¥æ­Œè¯
                    const options = selectedLyrics.map(item => item.lyric);

                    return {
                        correctIndex,
                        correctLyric: correctLyric.lyric,
                        correctSongTitle: correctLyric.songTitle,
                        options: options.sort(() => 0.5 - Math.random()) // æ‰“ä¹±é€‰é¡¹é¡ºåº
                    };
                });
            }, []);

            const current = questions[step];

            useEffect(() => {
                if (!finished && !retryMode && !justPlayedAudioRef.current) {
                    // æ’­æ”¾æ­£ç¡®çš„é‚£å¥æ­Œè¯
                    speak(current.correctLyric, 0.8);
                }
                // æ¯æ¬¡ step æ”¹å˜åé‡ç½® justPlayedAudioRef
                justPlayedAudioRef.current = false;
            }, [step, finished, retryMode]);

            const handleAnswer = (ans) => {
                if (feedback) return;
                const correct = ans === current.correctLyric;
                if (correct) {
                    speak("ç­”å¯¹å•¦ï¼çœŸæ£’ï¼");
                    setScore(s => s + 1);
                    setFeedback('correct');
                    // æ‰¾åˆ°å¯¹åº”çš„å„¿æ­ŒIDå¹¶æ ‡è®°ä¸ºæŒæ¡
                    const song = SONGS.find(s => s.title === current.correctSongTitle);
                    if (song) onSongMaster(song.id);
                    setRetryMode(false); // ç­”å¯¹åæ¸…é™¤é‡è¯•æ¨¡å¼
                    setTimeout(() => {
                        setFeedback(null);
                        if (step < CHALLENGE_QUESTION_COUNT - 1) {
                            const nextStep = step + 1;
                            // åœ¨åˆ‡æ¢åˆ°ä¸‹ä¸€é¢˜ä¹‹å‰ï¼Œå…ˆæ’­æ”¾ä¸‹ä¸€é¢˜çš„æ­£ç¡®æ­Œè¯
                            const nextQuestion = questions[nextStep];
                            speak(nextQuestion.correctLyric, 0.8);
                            justPlayedAudioRef.current = true; // æ ‡è®°å·²ç»æ‰‹åŠ¨æ’­æ”¾è¿‡
                            setStep(nextStep);
                        } else {
                            setFinished(true);
                        }
                    }, 1500);
                } else {
                    speak("å†å¬å¬çœ‹ï¼Ÿ");
                    setFeedback('wrong');
                    setRetryMode(true); // è¿›å…¥é‡è¯•æ¨¡å¼
                    // ç­”é”™åé‡æ–°æ’­æ”¾æ­£ç¡®æ­Œè¯ï¼Œè®©å­©å­é‡æ–°å¬
                    setTimeout(() => {
                        setFeedback(null);
                        speak(current.correctLyric, 0.8); // é‡æ–°æ’­æ”¾
                    }, 1500);
                }
            };

            if (finished) return (
                <div className="h-screen pt-20 px-8 flex flex-col items-center justify-center space-y-8 bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50">
                    <Header title="æ­Œè¯ä¾¦æ¢ç»“æœ" />
                    <div className="bg-white w-full p-12 rounded-[4rem] shadow-2xl text-center pop-up border-b-[15px] border-purple-200">
                        <div className="text-[8rem] mb-6 animate-bounce">ğŸ•µï¸</div>
                        <h2 className="text-4xl font-black text-gray-800 mb-4">æ­Œè¯ä¾¦æ¢æŒ‘æˆ˜å®Œæˆï¼</h2>
                        <div className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-500 to-pink-500 mb-8">
                            {score}/{CHALLENGE_QUESTION_COUNT}
                        </div>

                        {/* æ˜Ÿæ˜Ÿè¯„åˆ† */}
                        <div className="flex justify-center gap-2 mb-8">
                            {[...Array(5)].map((_, i) => (
                                <span key={i} className={`text-4xl ${i < Math.ceil(score / 2) ? 'text-yellow-400' : 'text-gray-300'}`}>
                                    â­
                                </span>
                            ))}
                        </div>

                        <div className="text-xl font-bold text-gray-600 mb-8">
                            {score >= 9 ? 'ğŸ‰ è¶…çº§æ£’ï¼ä½ æ˜¯æ­Œè¯ä¾¦æ¢ï¼' :
                             score >= 7 ? 'ğŸ˜Š çœŸæ£’ï¼è€³æœµçœŸçµï¼' :
                             score >= 5 ? 'ğŸ‘ ä¸é”™å“¦ï¼å¤šå¬å¬æ­Œè¯å§ï¼' :
                             'ğŸ’ª æ²¡å…³ç³»ï¼Œå¤šç»ƒä¹ å°±è¡Œï¼'}
                        </div>

                        <button onClick={onBack} className="w-full py-6 bg-gradient-to-r from-purple-400 to-pink-500 text-white rounded-[2.5rem] text-3xl font-black shadow-xl border-b-8 border-purple-600 active:translate-y-2 transition-all">
                            è¿”å›ä¸»é¡µ ğŸ¼
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 pt-20 px-6 flex flex-col items-center">
                    <Header title={`æ­Œè¯ä¾¦æ¢ ${step + 1}/${CHALLENGE_QUESTION_COUNT}`} onBack={onBack} />

                    {/* è¿›åº¦æŒ‡ç¤ºå™¨ */}
                    <div className="w-full max-w-md mb-6">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-sm font-bold text-gray-600">è¿›åº¦</span>
                            <span className="text-sm font-bold text-purple-600">{step + 1}/{CHALLENGE_QUESTION_COUNT}</span>
                        </div>
                        <div className="w-full bg-gray-200 h-4 rounded-full overflow-hidden shadow-inner">
                            <div className={`h-full bg-gradient-to-r from-purple-400 to-pink-400 rounded-full transition-all duration-500`} style={{ width: `${((step + 1) / CHALLENGE_QUESTION_COUNT) * 100}%` }} />
                        </div>
                    </div>

                    {/* æ’­æ”¾åŒºåŸŸ */}
                    <div
                        onClick={() => {
                            speak(current.correctLyric, 0.8);
                        }}
                        className={`w-full max-w-md glass-card rounded-[4rem] p-8 border-[15px] transition-all duration-300 cursor-pointer active:scale-95 relative overflow-hidden mb-6 ${
                            feedback === 'correct'
                                ? 'border-green-400 scale-105 shadow-green-200 shadow-2xl'
                                : feedback === 'wrong'
                                ? 'border-red-400 shadow-red-200 shadow-2xl'
                                : 'border-purple-200 shadow-purple-100'
                        }`}
                    >
                        {/* è£…é¥°èƒŒæ™¯ */}
                        <div className="absolute inset-0 opacity-10 pointer-events-none z-0">
                            <div className="absolute top-2 left-2 text-4xl">ğŸ¼</div>
                            <div className="absolute top-2 right-2 text-4xl">ğŸµ</div>
                            <div className="absolute bottom-2 left-2 text-4xl">ğŸ§</div>
                            <div className="absolute bottom-2 right-2 text-4xl">ğŸ•µï¸</div>
                        </div>

                        <div className="text-center relative z-30">
                            <div className="text-2xl font-black text-purple-600 mb-4 flex items-center justify-center gap-2">
                                <span className="text-3xl animate-pulse">ğŸ§</span> å¬å¬è¿™æ®µå„¿æ­Œ <span>ğŸµ</span>
                            </div>

                            <div className="text-3xl font-black text-purple-600 mb-4 flex items-center justify-center gap-3">
                                <span>ğŸ¤”</span> è¿™æ˜¯å“ªå¥æ­Œè¯ï¼Ÿ <span>ğŸ¤”</span>
                            </div>

                            {/* æ’­æ”¾çŠ¶æ€æŒ‡ç¤ºå™¨ */}
                            {!feedback && (
                                <div className="mt-2 p-3 bg-purple-100 rounded-xl border-2 border-purple-300">
                                    <div className="text-lg font-black text-purple-600 flex items-center justify-center gap-2">
                                        <span>ğŸ”Š</span> ç‚¹å‡»æ’­æ”¾æ­Œè¯...
                                    </div>
                                </div>
                            )}

                            {feedback === 'correct' && (
                                <div className="text-xl font-black text-green-600 mt-2 animate-bounce text-center">
                                    âœ… ç­”å¯¹å•¦ï¼<br/>è¿™æ˜¯ã€Š{current.correctSongTitle}ã€‹é‡Œçš„æ­Œè¯
                                </div>
                            )}
                            {feedback === 'wrong' && (
                                <div className="text-2xl font-black text-red-600 mt-2 animate-bounce">
                                    âŒ å†å¬å¬çœ‹ï¼Ÿ
                                </div>
                            )}
                        </div>
                    </div>

                    {/* é€‰é¡¹æŒ‰é’® */}
                    <div className="grid grid-cols-1 gap-4 w-full max-w-md mb-32">
                        {current.options.map((opt, idx) => (
                            <button
                                key={idx}
                                onClick={() => handleAnswer(opt)}
                                className={`py-4 px-4 bg-white rounded-[2rem] text-xl font-black text-gray-700 shadow-xl border-b-[8px] transition-all duration-300 ${
                                    feedback === 'correct' && opt === current.correctLyric
                                        ? 'border-green-400 bg-green-50 text-green-700 scale-105'
                                        : feedback === 'wrong' && opt === current.correctLyric
                                        ? 'border-green-400 bg-green-50 text-green-700 scale-105'
                                        : feedback === 'wrong'
                                        ? 'border-red-400 bg-red-50 text-red-700'
                                        : 'border-gray-100 hover:border-purple-300 hover:bg-purple-50 active:translate-y-2 active:border-b-4'
                                } disabled:opacity-50 relative overflow-hidden`}
                                disabled={feedback !== null}
                            >
                                {/* é€‰é¡¹ç¼–å· */}
                                <div className="absolute left-4 top-4 text-2xl font-black text-gray-300">
                                    {String.fromCharCode(65 + idx)}
                                </div>

                                {/* é€‰é¡¹å†…å®¹ */}
                                <div className="pl-12 pr-4 text-left leading-relaxed">
                                    {opt}
                                </div>

                                {/* æ­£ç¡®ç­”æ¡ˆæ ‡è®° */}
                                {feedback && opt === current.correctLyric && (
                                    <div className="absolute right-4 top-1/2 transform -translate-y-1/2 text-3xl animate-bounce">
                                        âœ¨
                                    </div>
                                )}
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        const SongExamScreen = ({ onBack, onSongMaster }) => {
            const [step, setStep] = useState(0);
            const [score, setScore] = useState(0);
            const [finished, setFinished] = useState(false);
            const [feedback, setFeedback] = useState(null);
            const [playing, setPlaying] = useState(false);
            const [showHint, setShowHint] = useState(false);
            const [hasPlayed, setHasPlayed] = useState(false);

            const questions = useMemo(() => {
                // ä»æ‰€æœ‰å„¿æ­Œä¸­åŠ¨æ€ç”Ÿæˆ10é“éšæœºé¢˜ç›®
                const generatedQuestions = [];
                const usedSongs = new Set(); // é¿å…é‡å¤ä½¿ç”¨åŒä¸€é¦–å„¿æ­Œ

                while (generatedQuestions.length < CHALLENGE_QUESTION_COUNT) {
                    // éšæœºé€‰æ‹©ä¸€é¦–å„¿æ­Œ
                    const availableSongs = SONGS.filter(song => !usedSongs.has(song.id));
                    if (availableSongs.length === 0) break; // å¦‚æœæ‰€æœ‰å„¿æ­Œéƒ½ç”¨å®Œäº†ï¼Œåœæ­¢

                    const randomSong = availableSongs[Math.floor(Math.random() * availableSongs.length)];
                    usedSongs.add(randomSong.id);

                    // ä¸ºè¿™é¦–å„¿æ­Œéšæœºé€‰æ‹©ä¸€å¥æ­Œè¯ï¼ˆä¸èƒ½æ˜¯æœ€åä¸€å¥ï¼Œå› ä¸ºéœ€è¦æœ‰ä¸‹ä¸€å¥ä½œä¸ºç­”æ¡ˆï¼‰
                    const maxIndex = randomSong.content.length - 2; // ç•™å‡ºè‡³å°‘ä¸€å¥ä½œä¸ºç­”æ¡ˆ
                    if (maxIndex < 0) continue; // å¦‚æœå„¿æ­Œå¤ªçŸ­ï¼Œè·³è¿‡

                    const playIndex = Math.floor(Math.random() * (maxIndex + 1));
                    const playLyrics = [randomSong.content[playIndex]];
                    const correctAnswer = randomSong.content[playIndex + 1];

                    // ç”Ÿæˆé”™è¯¯é€‰é¡¹ï¼šä»å…¶ä»–å„¿æ­Œä¸­éšæœºé€‰æ‹©ä¸åŒçš„å¥å­
                    const wrongOptions = [];
                    const otherSongs = SONGS.filter(song => song.id !== randomSong.id);

                    while (wrongOptions.length < 2) {
                        const randomOtherSong = otherSongs[Math.floor(Math.random() * otherSongs.length)];
                        const randomLine = randomOtherSong.content[Math.floor(Math.random() * randomOtherSong.content.length)];

                        // ç¡®ä¿é”™è¯¯é€‰é¡¹ä¸ä¸æ­£ç¡®ç­”æ¡ˆé‡å¤
                        if (!wrongOptions.includes(randomLine) && randomLine !== correctAnswer) {
                            wrongOptions.push(randomLine);
                        }
                    }

                    // åˆ›å»ºé€‰é¡¹æ•°ç»„ï¼šæ­£ç¡®ç­”æ¡ˆ + é”™è¯¯é€‰é¡¹ï¼Œç„¶åéšæœºæ’åº
                    const allOptions = [correctAnswer, ...wrongOptions];
                    const shuffledOptions = allOptions.sort(() => 0.5 - Math.random());

                    generatedQuestions.push({
                        id: generatedQuestions.length + 1,
                        songId: randomSong.id,
                        playLyrics: playLyrics,
                        correct: correctAnswer,
                        options: shuffledOptions
                    });
                }

                return generatedQuestions;
            }, []);

            const current = questions[step];

            const playLyrics = () => {
                if (playing) return;
                setPlaying(true);
                speak(current.playLyrics.join(''), 0.8);
                setTimeout(() => {
                    setPlaying(false);
                    setHasPlayed(true);
                }, 2000);
            };

            const handleAnswer = (ans) => {
                if (feedback || !hasPlayed) return; // åªæœ‰æ’­æ”¾åæ‰èƒ½é€‰æ‹©ç­”æ¡ˆ
                const correct = ans === current.correct;
                if (correct) {
                    speak("ç­”å¯¹å•¦ï¼çœŸæ£’ï¼");
                    setScore(s => s + 1);
                    setFeedback('correct');
                    onSongMaster(current.songId);
                    // ç­”å¯¹æ—¶æ‰è·³åˆ°ä¸‹ä¸€é¢˜
                    setTimeout(() => {
                        setFeedback(null);
                        if (step < CHALLENGE_QUESTION_COUNT - 1) setStep(s => s + 1);
                        else setFinished(true);
                    }, 1500);
                } else {
                    speak("å†å¬å¬çœ‹ï¼Ÿ");
                    setFeedback('wrong');
                    // ç­”é”™æ—¶é‡æ–°æ’­æ”¾æ­Œè¯ï¼Œè®©å­©å­é‡æ–°å¬
                    setTimeout(() => {
                        setFeedback(null);
                        setHasPlayed(false);
                        // é‡æ–°æ’­æ”¾
                        setTimeout(() => {
                            playLyrics();
                        }, 300);
                    }, 1500);
                }
            };

            // åˆå§‹åŒ–æ—¶è‡ªåŠ¨æ’­æ”¾ç¬¬ä¸€é¢˜
            React.useEffect(() => {
                if (current && step === 0 && !finished && !hasPlayed) {
                    setTimeout(() => {
                        playLyrics();
                    }, 800); // ç»™é¡µé¢åŠ è½½ä¸€ç‚¹æ—¶é—´
                }
            }, []);

            // åˆ‡æ¢åˆ°æ–°é¢˜ç›®æ—¶è‡ªåŠ¨æ’­æ”¾ä¸€æ¬¡
            React.useEffect(() => {
                if (current && step > 0 && !finished) {
                    setHasPlayed(false);
                    setShowHint(false); // é‡ç½®æç¤ºçŠ¶æ€
                    // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´è‡ªåŠ¨æ’­æ”¾ï¼Œè®©UIå…ˆæ›´æ–°
                    setTimeout(() => {
                        playLyrics();
                    }, 500);
                }
            }, [step]);

            // è¿›åº¦æ¡é¢œè‰²
            const getProgressColor = () => {
                const progress = (step + 1) / CHALLENGE_QUESTION_COUNT;
                if (progress <= 0.3) return 'from-red-400 to-orange-400';
                if (progress <= 0.6) return 'from-orange-400 to-yellow-400';
                if (progress <= 0.8) return 'from-yellow-400 to-green-400';
                return 'from-green-400 to-blue-400';
            };

            if (finished) return (
                <div className="h-screen pt-20 px-8 flex flex-col items-center justify-center space-y-8 bg-gradient-to-br from-pink-50 via-purple-50 to-blue-50">
                    <Header title="å„¿æ­ŒæŒ‘æˆ˜ç»“æœ" />
                    <div className="bg-white w-full p-12 rounded-[4rem] shadow-2xl text-center pop-up border-b-[15px] border-pink-200">
                        <div className="text-[8rem] mb-6 animate-bounce">ğŸµ</div>
                        <h2 className="text-4xl font-black text-gray-800 mb-4">å„¿æ­ŒæŒ‘æˆ˜å®Œæˆï¼</h2>
                        <div className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-purple-500 mb-8">
                            {score}/{CHALLENGE_QUESTION_COUNT}
                        </div>

                        {/* æ˜Ÿæ˜Ÿè¯„åˆ† */}
                        <div className="flex justify-center gap-2 mb-8">
                            {[...Array(5)].map((_, i) => (
                                <span key={i} className={`text-4xl ${i < Math.ceil(score / 2) ? 'text-yellow-400' : 'text-gray-300'}`}>
                                    â­
                                </span>
                            ))}
                        </div>

                        <div className="text-xl font-bold text-gray-600 mb-8">
                            {score >= 9 ? 'ğŸ‰ è¶…çº§æ£’ï¼ä½ æ˜¯å„¿æ­Œå°å¤©æ‰ï¼' :
                             score >= 7 ? 'ğŸ˜Š çœŸæ£’ï¼ç»§ç»­åŠ æ²¹ï¼' :
                             score >= 5 ? 'ğŸ‘ ä¸é”™å“¦ï¼å†æ¥å†å‰ï¼' :
                             'ğŸ’ª æ²¡å…³ç³»ï¼Œå¤šå¬å¤šç»ƒå°±è¡Œï¼'}
                        </div>

                        <button onClick={onBack} className="w-full py-6 bg-gradient-to-r from-green-400 to-blue-500 text-white rounded-[2.5rem] text-3xl font-black shadow-xl border-b-8 border-green-600 active:translate-y-2 transition-all">
                            è¿”å›ä¸»é¡µ ğŸ 
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="h-screen bg-gradient-to-br from-pink-50 via-purple-50 to-blue-50 pt-20 px-6 flex flex-col items-center">
                    <Header title={`å„¿æ­ŒæŒ‘æˆ˜ ${step + 1}/${CHALLENGE_QUESTION_COUNT}`} onBack={onBack} />

                    {/* è¿›åº¦æŒ‡ç¤ºå™¨ */}
                    <div className="w-full max-w-md mb-6">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-sm font-bold text-gray-600">è¿›åº¦</span>
                            <span className="text-sm font-bold text-pink-600">{step + 1}/{CHALLENGE_QUESTION_COUNT}</span>
                        </div>
                        <div className="w-full bg-gray-200 h-4 rounded-full overflow-hidden shadow-inner">
                            <div className={`h-full bg-gradient-to-r ${getProgressColor()} rounded-full transition-all duration-500`} style={{ width: `${((step + 1) / CHALLENGE_QUESTION_COUNT) * 100}%` }} />
                        </div>
                    </div>

                    {/* èåˆæ’­æ”¾å’Œé—®é¢˜åŒºåŸŸ - å‚è€ƒæ­Œè¯å°ä¾¦æ¢è®¾è®¡é£æ ¼ */}
                    <div
                        onClick={playLyrics}
                        className={`w-full max-w-md glass-card rounded-[4rem] p-8 border-[15px] transition-all duration-500 cursor-pointer active:scale-95 relative overflow-hidden mb-6 ${
                            feedback === 'correct'
                                ? 'border-green-400 scale-105 shadow-green-200 shadow-2xl'
                                : feedback === 'wrong'
                                ? 'border-red-400 shake shadow-red-200 shadow-2xl'
                                : 'border-pink-200 shadow-pink-100'
                        }`}
                    >
                        {/* è£…é¥°èƒŒæ™¯ */}
                        <div className="absolute inset-0 opacity-10 pointer-events-none z-0">
                            <div className="absolute top-2 left-2 text-4xl">ğŸ¼</div>
                            <div className="absolute top-2 right-2 text-4xl">ğŸµ</div>
                            <div className="absolute bottom-2 left-2 text-4xl">ğŸ¶</div>
                            <div className="absolute bottom-2 right-2 text-4xl">ğŸµ</div>
                        </div>

                        <div className="text-center relative z-30">
                            <div className="text-2xl font-black text-pink-600 mb-4 flex items-center justify-center gap-2">
                                <span className="text-3xl animate-pulse">ğŸ§</span> å¬å¬è¿™æ®µå„¿æ­Œ <span>ğŸµ</span>
                            </div>

                            <div className="text-3xl font-black text-pink-600 mb-4 flex items-center justify-center gap-3">
                                <span>ğŸ¤”</span> ä¸‹ä¸€å¥æ˜¯ä»€ä¹ˆï¼Ÿ <span>ğŸ¤”</span>
                            </div>

                            {/* æ˜¾ç¤ºæ­Œè¯ */}
                            <div className="bg-white/70 backdrop-blur-sm rounded-2xl p-4 shadow-lg relative z-30 mb-4">
                                <div className="text-2xl font-black text-gray-700 leading-relaxed">
                                    {current.playLyrics.join('')}
                                </div>
                            </div>

                            {/* æ’­æ”¾çŠ¶æ€æŒ‡ç¤ºå™¨ */}
                            {!feedback && (
                                <div className="mt-2 p-3 bg-pink-100 rounded-xl border-2 border-pink-300">
                                    <div className="text-lg font-black text-pink-600 flex items-center justify-center gap-2">
                                        {!hasPlayed ? (
                                            <>
                                                <span>ğŸ”Š</span> ç‚¹å‡»æ’­æ”¾å„¿æ­Œ...
                                            </>
                                        ) : (
                                            <>
                                                <span>âœ¨</span> å¬å®Œäº†å—ï¼Ÿç°åœ¨è¯·é€‰æ‹©ç­”æ¡ˆå§ï¼
                                            </>
                                        )}
                                    </div>
                                </div>
                            )}

                            {feedback === 'correct' && (
                                <div className="text-xl font-black text-green-600 mt-2 animate-bounce text-center">
                                    âœ… ç­”å¯¹å•¦ï¼çœŸæ£’ï¼
                                </div>
                            )}
                            {feedback === 'wrong' && (
                                <div className="text-2xl font-black text-red-600 mt-2 animate-bounce">
                                    âŒ å†å¬å¬çœ‹ï¼Ÿ
                                </div>
                            )}

                            {/* æç¤ºæŒ‰é’® */}
                            <button
                                onClick={() => setShowHint(!showHint)}
                                className="mt-4 px-6 py-2 bg-blue-100 text-blue-600 rounded-full text-sm font-bold hover:bg-blue-200 transition-all"
                            >
                                ğŸ’¡ {showHint ? 'éšè—æç¤º' : 'æ˜¾ç¤ºæç¤º'}
                            </button>

                            {showHint && (
                                <div className="mt-3 p-3 bg-yellow-100 rounded-xl border-2 border-yellow-300">
                                    <p className="text-sm text-yellow-800 font-bold">
                                        ä»”ç»†å¬æ­Œè¯ï¼Œæƒ³æƒ³ä¸‹ä¸€å¥æœ€å¯èƒ½æ˜¯ä»€ä¹ˆå“¦ï¼
                                    </p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* é€‰é¡¹æŒ‰é’® */}
                    <div className="grid grid-cols-1 gap-4 w-full max-w-md mb-32">
                        {current.options.map((opt, idx) => (
                            <button
                                key={idx}
                                onClick={() => handleAnswer(opt)}
                                className={`py-6 px-4 bg-white rounded-[2rem] text-2xl font-black text-gray-700 shadow-xl border-b-[8px] transition-all duration-300 ${
                                    feedback === 'correct' && opt === current.correct
                                        ? 'border-green-400 bg-green-50 text-green-700 scale-105'
                                        : feedback === 'wrong' && opt === current.correct
                                        ? 'border-green-400 bg-green-50 text-green-700 scale-105'
                                        : feedback === 'wrong'
                                        ? 'border-red-400 bg-red-50 text-red-700'
                                        : !hasPlayed
                                        ? 'border-gray-300 bg-gray-100 text-gray-400 cursor-not-allowed'
                                        : 'border-gray-100 hover:border-purple-300 hover:bg-purple-50 active:translate-y-2 active:border-b-4'
                                } disabled:opacity-50 relative overflow-hidden`}
                                disabled={feedback !== null || !hasPlayed}
                            >
                                {/* é€‰é¡¹ç¼–å· */}
                                <div className="absolute left-4 top-1/2 transform -translate-y-1/2 text-2xl font-black text-gray-300">
                                    {String.fromCharCode(65 + idx)}
                                </div>

                                {/* é€‰é¡¹å†…å®¹ */}
                                <div className="pl-8 text-center">
                                    {opt}
                                </div>

                                {/* æ­£ç¡®ç­”æ¡ˆæ ‡è®° */}
                                {feedback && opt === current.correct && (
                                    <div className="absolute right-4 top-1/2 transform -translate-y-1/2 text-3xl animate-bounce">
                                        âœ¨
                                    </div>
                                )}
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        const Main = () => {
            const [mode, setMode] = useState('HOME');
            const [confetti, setConfetti] = useState(false);
            const [progress, setProgress] = useState(() => {
                const s = localStorage.getItem('baby_study_master_v1');
                return s ? JSON.parse(s) : { mastered: [], daily: 0, last: '', wrong: {}, readSongs: [] };
            });

            useEffect(() => {
                const today = new Date().toLocaleDateString();
                if (progress.last !== today) setProgress(p => ({ ...p, daily: 0, last: today }));
            }, []);

            useEffect(() => localStorage.setItem('baby_study_master_v1', JSON.stringify(progress)), [progress]);

            const triggerWin = () => { setConfetti(true); setTimeout(() => setConfetti(false), 2500); };

            const handleMaster = (idx) => {
                setProgress(p => {
                    const isNew = !p.mastered.includes(idx);
                    if (isNew) triggerWin();
                    return { ...p, mastered: isNew ? [...p.mastered, idx] : p.mastered, daily: isNew ? p.daily + 1 : p.daily };
                });
            };

            const handleWrong = (idx) => {
                setProgress(p => {
                    const newW = { ...p.wrong };
                    newW[idx] = (newW[idx] || 0) + 1;
                    return { ...p, wrong: newW };
                });
            };

            const handleReadSong = (id) => {
                setProgress(p => {
                    const isNew = !p.readSongs.includes(id);
                    if (isNew) triggerWin();
                    return { ...p, readSongs: isNew ? [...p.readSongs, id] : p.readSongs, daily: isNew ? p.daily + 1 : p.daily };
                });
            };

            const handleSongExamMaster = (songId) => {
                setProgress(p => {
                    const isNew = !p.readSongs.includes(songId);
                    if (isNew) triggerWin();
                    return { ...p, readSongs: isNew ? [...p.readSongs, songId] : p.readSongs, daily: isNew ? p.daily + 1 : p.daily };
                });
            };

            return (
                <div className="min-h-screen">
                    {confetti && <Confetti />}
                    {mode === 'HOME' && <HomeScreen setMode={setMode} progress={progress} />}
                    {mode === 'CARDS' && <CardScreen onBack={() => setMode('HOME')} onMaster={handleMaster} progress={progress} />}
                    {mode === 'SONGS' && <SongScreen onBack={() => setMode('HOME')} onRead={handleReadSong} progress={progress} />}
                    {mode === 'POEMS' && <PoemsScreen onBack={() => setMode('HOME')} progress={progress} />}
                    {mode === 'STATS' && <StatsScreen progress={progress} />}
                    {mode === 'EXAM_SELECT' && (
                        <div className="h-screen overflow-y-auto pt-14 px-4 space-y-4">
                            <Header title="äº²å­å¤§æŒ‘æˆ˜" onBack={() => setMode('HOME')} />
                            <div className="grid grid-cols-1 gap-4 mt-4">
                                <button onClick={() => setMode('EXAM_WORDS')} className="bg-white p-8 rounded-[3rem] shadow-2xl border-b-[12px] border-orange-200 flex flex-col items-center active:scale-95 transition-all">
                                    <span className="text-[6rem] mb-3">ğŸˆ</span>
                                    <h3 className="text-3xl font-black text-orange-600">è¯†å­—å°æ ‡å…µ</h3>
                                </button>
                                <button onClick={() => setMode('EXAM_SONG_RECOG')} className="bg-white p-8 rounded-[3rem] shadow-2xl border-b-[12px] border-purple-200 flex flex-col items-center active:scale-95 transition-all">
                                    <span className="text-[6rem] mb-3">ğŸ•µï¸</span>
                                    <h3 className="text-3xl font-black text-purple-600">æ­Œè¯å°ä¾¦æ¢</h3>
                                </button>
                                <button onClick={() => setMode('EXAM_SONGS')} className="bg-white p-8 rounded-[3rem] shadow-2xl border-b-[12px] border-pink-200 flex flex-col items-center active:scale-95 transition-all">
                                    <span className="text-[6rem] mb-3">ğŸµ</span>
                                    <h3 className="text-3xl font-black text-pink-600">å„¿æ­Œå°èƒ½æ‰‹</h3>
                                </button>
                                <div className="bg-pink-100 p-6 rounded-[2.5rem] text-center border-2 border-pink-200">
                                    <p className="text-pink-600 font-black">ğŸ’¡ äº²å­æ—¶åˆ»ï¼šè¯·å¿µå‡ºé¢˜ç›®è®©å®å®é€‰</p>
                                </div>
                            </div>
                        </div>
                    )}
                    {mode === 'EXAM_WORDS' && <ExamScreen onBack={() => setMode('EXAM_SELECT')} onMaster={handleMaster} onWrong={handleWrong} />}
                    {mode === 'EXAM_SONG_RECOG' && <SongRecognitionExamScreen onBack={() => setMode('EXAM_SELECT')} onSongMaster={handleSongExamMaster} />}
                    {mode === 'EXAM_SONGS' && <SongExamScreen onBack={() => setMode('EXAM_SELECT')} onSongMaster={handleSongExamMaster} />}
                    <Navbar active={mode} setMode={setMode} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Main />);
    </script>
    <script>
        // å¼ºåˆ¶æ¸…é™¤æ—§ç¼“å­˜å’ŒService Workerï¼ˆä»…åœ¨éœ€è¦æ—¶ï¼‰
        // åªåœ¨ HTTP/HTTPS åè®®ä¸‹æ³¨å†Œ Service Worker
        if ('serviceWorker' in navigator && (window.location.protocol === 'http:' || window.location.protocol === 'https:')) {
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ¸…é™¤æ—§ç¼“å­˜ï¼ˆé€šè¿‡URLå‚æ•°æ§åˆ¶ï¼‰
            const urlParams = new URLSearchParams(window.location.search);
            const clearCache = urlParams.get('clearCache') === 'true' || localStorage.getItem('sw_clear_needed') === 'true';
            
            if (clearCache) {
                // å…ˆæ³¨é”€æ‰€æœ‰æ—§çš„Service Worker
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister();
                    }
                    // æ¸…é™¤æ‰€æœ‰ç¼“å­˜
                    if ('caches' in window) {
                        caches.keys().then(function(names) {
                            for (let name of names) {
                                caches.delete(name);
                            }
                            localStorage.removeItem('sw_clear_needed');
                            // æ¸…é™¤ç¼“å­˜åé‡æ–°æ³¨å†Œæ–°çš„Service Worker
                            setTimeout(() => {
                                navigator.serviceWorker.register('./sw.js?v=10').catch(() => {});
                                location.reload();
                            }, 100);
                        });
                    }
                });
            } else {
                // æ­£å¸¸æ³¨å†ŒService Worker
                navigator.serviceWorker.register('./sw.js?v=10').catch(() => {});
            }
        }
    </script>
</body>
</html>
